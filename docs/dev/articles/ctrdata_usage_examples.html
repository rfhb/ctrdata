<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examples for using R package `ctrdata` for clinical trial information • ctrdata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Examples for using R package `ctrdata` for clinical trial information">
<meta property="og:description" content="ctrdata">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@rfhb">
<meta name="twitter:site" content="@rfhb">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctrdata</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.2.1.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ctrdata_get_started.html">Getting started with R package `ctrdata` for clinical trial information</a>
    </li>
    <li>
      <a href="../articles/ctrdata_usage_examples.html">Examples for using R package `ctrdata` for clinical trial information</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rfhb/ctrdata/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ctrdata_usage_examples_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Examples for using R package <code>ctrdata</code> for clinical trial information</h1>
                        <h4 class="author">Ralf Herold</h4>
            
            <h4 class="date">2019-09-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rfhb/ctrdata/blob/master/vignettes/ctrdata_usage_examples.Rmd"><code>vignettes/ctrdata_usage_examples.Rmd</code></a></small>
      <div class="hidden name"><code>ctrdata_usage_examples.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># helper functions</span>
<span class="co">#</span>
<span class="no">normalise_number</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {

  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"&amp;lt;|&amp;gt;"</span>, <span class="st">""</span>,  <span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"&lt;=|&lt;|≤|=|&gt;"</span>, <span class="st">""</span>,  <span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"(^| )[.]"</span>, <span class="st">"0."</span>, <span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span>(<span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">x</span>, <span class="kw">function</span>(<span class="no">y</span>) {
    <span class="no">z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/try.html">try</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">y</span>), <span class="kw">silent</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">z</span>) <span class="kw">==</span> <span class="st">"try-error"</span>) {
      <span class="fl">NA</span>
      <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="no">z</span>)
    } <span class="kw">else</span> {
      <span class="no">z</span>
    }
  })
  <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span>(<span class="no">x</span>)
}
<span class="co">#</span>
<span class="no">normalise_string</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {

  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">","</span>, <span class="st">""</span>,  <span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"-"</span>, <span class="st">" "</span>, <span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span>(<span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="kw pkg">tools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/tools/toTitleCase.html">toTitleCase</a></span>(<span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"[ ]+"</span>, <span class="st">" "</span>, <span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span>(<span class="no">x</span>)
  <span class="no">x</span>

}
<span class="co">#</span>
<span class="no">grepl_multi</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">patterns</span>, <span class="no">x</span>, <span class="no">simplify</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/vector.html">is.vector</a></span>(<span class="no">patterns</span>)) <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"patterns should be a vector."</span>)
  <span class="no">ret</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">patterns</span>), <span class="fl">1</span>, <span class="kw">function</span>(<span class="no">pattern</span>) <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="no">pattern</span>, <span class="no">x</span>, <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>))
  <span class="no">ret</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">ret</span>)
  <span class="kw">if</span> (<span class="no">simplify</span>)
    <span class="no">ret</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">ret</span>) <span class="kw">&gt;=</span> <span class="fl">1</span>
  <span class="kw">else</span>
    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">ret</span>) <span class="kw">&lt;-</span> <span class="no">patterns</span>
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">ret</span>)
}
<span class="co">#</span>
<span class="no">age_ctgov</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {

  <span class="no">tmp.years</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"([0-9]+) Year.?"</span>,  <span class="st">"\\1"</span>, <span class="no">x</span>, <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>))) / <span class="fl">1</span>
  <span class="no">tmp.months</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"([0-9]+) Month.?"</span>, <span class="st">"\\1"</span>, <span class="no">x</span>, <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>))) / <span class="fl">12</span>
  <span class="no">tmp.days</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"([0-9]+) Day.?"</span>,   <span class="st">"\\1"</span>, <span class="no">x</span>, <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>))) / <span class="fl">365.25</span>

  <span class="no">tmp.age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">tmp.years</span>),  <span class="no">tmp.years</span>,
             <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">tmp.months</span>), <span class="no">tmp.months</span>,
             <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">tmp.days</span>),   <span class="no">tmp.days</span>, <span class="fl">NA</span>)))

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">tmp.age</span>)
}
<span class="co">#</span>
<span class="no">simplifyList</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">l</span>) {

  <span class="co"># helper function to avoid</span>
  <span class="co"># that NULL is ignored / removed</span>
  <span class="no">rapply2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">fn</span>) {
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span>(<span class="no">x</span>)) {
      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">x</span>, <span class="no">rapply2</span>, <span class="no">fn</span>)
    } <span class="kw">else</span> {
      <span class="fu">fn</span>(<span class="no">x</span>)
    }
  }

  <span class="co"># apply function replacing</span>
  <span class="co"># NULL with e.g. NA</span>
  <span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu">rapply2</span>(<span class="no">l</span>,
                 <span class="kw">function</span>(<span class="no">x</span>) <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">x</span>)) <span class="fl">NA</span> <span class="kw">else</span> <span class="no">x</span>)

  <span class="co"># recursively unlist and change to vector</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">x</span>)))

}</pre></body></html></div>
<p>General information on the <code>ctrdata</code> package is available here: <a href="https://github.com/rfhb/ctrdata">https://github.com/rfhb/ctrdata</a>.</p>
<div id="internet-access-via-proxy" class="section level2">
<h2 class="hasAnchor">
<a href="#internet-access-via-proxy" class="anchor"></a>Internet access via proxy</h2>
<p>Functions in package <code>ctrdata</code> that start with <code>ctr...</code> require access to internet resources via <code>https</code>. Package <code>ctrdata</code> checks and automatically uses the proxy that is set under MS Windows in system settings. However, proxy settings need to be set by the user for other operating systems and for authenticating proxies, such as follows:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span>(<span class="kw">https_proxy</span> <span class="kw">=</span> <span class="st">"your_proxy.server.domain:8080"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span>(<span class="kw">https_proxy_user</span> <span class="kw">=</span> <span class="st">"userid:password"</span>)</pre></body></html></div>
</div>
<div id="connect-to-a-database" class="section level2">
<h2 class="hasAnchor">
<a href="#connect-to-a-database" class="anchor"></a>Connect to a database</h2>
<p>Here using MongoDB, which is faster than SQLite, can handle credentials, provides access to remote servers and can directly retrieve nested elements from paths. See <a href="../README.html">README.md</a> and <a href="ctrdata_get_started.Rmd">Get started with ctrdata</a> for examples using SQLite.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">db</span> <span class="kw">&lt;-</span> <span class="kw pkg">nodbi</span><span class="kw ns">::</span><span class="fu"><a href="https://docs.ropensci.org/nodbi/reference/src_mongo.html">src_mongo</a></span>(<span class="kw">url</span> <span class="kw">=</span> <span class="st">"mongodb://localhost"</span>,
                       <span class="kw">db</span> <span class="kw">=</span> <span class="st">"some_database_name"</span>,
                       <span class="kw">collection</span> <span class="kw">=</span> <span class="st">"some_collection_name"</span>)
<span class="no">db</span>
<span class="co"># MongoDB 3.6.8 (uptime: 244492s)</span>
<span class="co"># URL: laptop.home/some_database_name </span>
<span class="co"># Collection: some_collection_name</span></pre></body></html></div>
</div>
<div id="execute-a-search-query-and-load-into-database" class="section level2">
<h2 class="hasAnchor">
<a href="#execute-a-search-query-and-load-into-database" class="anchor"></a>Execute a search query and load into database</h2>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># Load library which has previously been installed:</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ctrdata</span>)

<span class="co"># In the browser, this is a search query used as example: </span>
<span class="co"># all phase 3 adult breast cancer trials</span>
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://www.clinicaltrialsregister.eu/ctr-search/search?"</span>,
            <span class="st">"query=cancer+AND+breast&amp;age=adult&amp;phase=phase-three"</span>)

<span class="co"># Load details on all clinical trials into database:</span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(<span class="kw">queryterm</span> <span class="kw">=</span> <span class="no">q</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="co"># * Found search query from EUCTR.</span>
<span class="co"># * Checking trials in EUCTR:</span>
<span class="co"># Retrieved overview, 403 trial(s) from 21 page(s) to be downloaded.</span>
<span class="co"># Checking helper binaries: . . done.</span>
<span class="co"># (1/3) Downloading trials (max. 10 page[s] in parallel):</span>
<span class="co">#  p 1-10 . . . . . . . . . .  p 11-20 . . . . . . . . . .  p 21-21 . </span>
<span class="co"># (2/3) Converting to JSON ...</span>
<span class="co"># (3/3) Importing JSON into database ...</span>
<span class="co"># Warnung: [WARNING] invalid document for insert: keys cannot contain </span>
<span class="co"># ".": "d391_cas_number.1" 2012-000174-37-ES: Error : invalid document</span></pre></body></html></div>
</div>
<div id="execute-in-browser-a-search-query-that-was-previously-stored" class="section level2">
<h2 class="hasAnchor">
<a href="#execute-in-browser-a-search-query-that-was-previously-stored" class="anchor"></a>Execute in browser a search query that was previously stored</h2>
<p>The function <code><a href="../reference/ctrOpenSearchPagesInBrowser.html">ctrOpenSearchPagesInBrowser()</a></code> can be used to open blank search pages, but also to execute a previous search. This can be used to check if user searches are properly handled by this package, for example by comparing the number of search results.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># After records have already been downloaded: </span>
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)   <span class="co"># list the searches in database</span>
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span>[<span class="fl">1</span>,]                      <span class="co"># select one of the searches</span>
<span class="fu"><a href="../reference/ctrOpenSearchPagesInBrowser.html">ctrOpenSearchPagesInBrowser</a></span>(<span class="no">q</span>)  <span class="co"># open this search in broweser</span>

<span class="co"># This opens a browser and executes a search:</span>
<span class="fu"><a href="../reference/ctrOpenSearchPagesInBrowser.html">ctrOpenSearchPagesInBrowser</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
  <span class="st">"https://www.clinicaltrialsregister.eu/"</span>,
  <span class="st">"ctr-search/search?query=cancer"</span>))</pre></body></html></div>
</div>
<div id="find-fields-variables-of-interest" class="section level2">
<h2 class="hasAnchor">
<a href="#find-fields-variables-of-interest" class="anchor"></a>Find fields / variables of interest</h2>
<p>The search for fields is cached and thus accelerated during the R session and as long as no new ctrLoadQueryIntoDb() is executed.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/dbFindFields.html">dbFindFields</a></span>(<span class="kw">namepart</span> <span class="kw">=</span> <span class="st">"date"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="co">#  [1] "firstreceived_date"                                                               </span>
<span class="co">#  [2] "lastchanged_date"                                                                 </span>
<span class="co">#  [3] "required_header.download_date"                                                    </span>
<span class="co">#  [4] "verification_date"                                                                </span>
<span class="co">#  [5] "start_date"                                                                       </span>
<span class="co">#  [6] "primary_completion_date"                                                          </span>
<span class="co">#  [7] "completion_date"                                                                  </span>
<span class="co">#  [8] "x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"           </span>
<span class="co">#  [9] "n_date_of_competent_authority_decision"                                           </span>
<span class="co"># [10] "n_date_of_ethics_committee_opinion"                                               </span>
<span class="co"># [11] "firstreceived_results_date"                                                       </span>
<span class="co"># [12] "p_date_of_the_global_end_of_the_trial"                                            </span></pre></body></html></div>
</div>
<div id="ctrdata-returns-include-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#ctrdata-returns-include-metadata" class="anchor"></a>ctrdata returns include metadata</h2>
<p>The objects returned by functions of this package include attributes with metadata to indicate from which query, database, collection etc. and when the object was created. Metadata can subsequently be reused.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(
  <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
    <span class="st">"e52_secondary_end_points"</span>,
    <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>))
<span class="co"># $class</span>
<span class="co"># [1] "data.frame"</span>
<span class="co"># </span>
<span class="co"># $`ctrdata-dbname`</span>
<span class="co"># [1] "some_database_name"</span>
<span class="co"># </span>
<span class="co"># $`ctrdata-table`</span>
<span class="co"># [1] "some_collection_name"</span>
<span class="co"># </span>
<span class="co"># $`ctrdata-dbqueryhistory`</span>
<span class="co">#       query-timestamp query-register query-records</span>
<span class="co"># 1 2019-10-13 21:18:50          EUCTR          1917</span>
<span class="co">#                                            query-term</span>
<span class="co"># 1 query=cancer+AND+breast&amp;age=adult&amp;phase=phase-three</span></pre></body></html></div>
</div>
<div id="update-data-base-from-query-in-specified-register" class="section level2">
<h2 class="hasAnchor">
<a href="#update-data-base-from-query-in-specified-register" class="anchor"></a>Update data base from query in specified register</h2>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># List queries:</span>
<span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Update last query in the history:</span>
<span class="co">#  - EUCTR information can be incrementally downloaded or updated only</span>
<span class="co">#    for the last 7 days, after which a full new download is necessary. </span>
<span class="co">#  - CTGOV intformation can always be incrementally downloaded or updated. </span>
<span class="co">#  - Alternatively, querytoupdate can have an integer number, </span>
<span class="co">#    corresponding to the desired row of dbQueryHistory(). </span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(<span class="kw">querytoupdate</span> <span class="kw">=</span> <span class="st">"last"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="co"># Note: after such an update, the column "query-records" refers </span>
<span class="co"># to the number of records that were added or updated, only, </span>
<span class="co"># when the update was run as per the "query-timestamp", </span>
<span class="co"># not to the total number of records. </span>

<span class="co"># The date and time of the last download of individual records</span>
<span class="co"># is stored in the variable "record_last_import" as follows: </span>
<span class="no">resultDate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="st">"record_last_import"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">resultDate</span><span class="kw">[[</span><span class="st">"record_last_import"</span>]])
<span class="co">#                  Min.               1st Qu.                Median</span>
<span class="co"># "2016-04-21 19:49:54" "2016-04-21 19:49:54" "2016-04-21 19:49:54"</span></pre></body></html></div>
</div>
<div id="deduplicate-country-specific-records-of-a-trial-visualise-trial-information" class="section level2">
<h2 class="hasAnchor">
<a href="#deduplicate-country-specific-records-of-a-trial-visualise-trial-information" class="anchor"></a>Deduplicate country-specific records of a trial, visualise trial information</h2>
<p>Note EUCTR provides country-specific records for trials, see README.md.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># Example 1: Relation between number of study </span>
<span class="co"># participants in one country and in whole trial? </span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"f41_in_the_member_state"</span>,
    <span class="st">"f422_in_the_whole_clinical_trial"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">f41_in_the_member_state</span> ~
       <span class="no">f422_in_the_whole_clinical_trial</span>, <span class="no">result</span>)
<span class="co"># [result not shown]</span>

<span class="co"># Example 2: How many clinical trials are </span>
<span class="co"># ongoing or completed, per country?</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"a1_member_state_concerned"</span>,
  <span class="st">"p_end_of_trial_status"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">result</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">a1_member_state_concerned</span>,
           <span class="no">p_end_of_trial_status</span>))
<span class="co"># [result not shown]</span>

<span class="co"># Example 3: How many clinical trials where started in which year?</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"a1_member_state_concerned"</span>,
  <span class="st">"n_date_of_competent_authority_decision"</span>,
  <span class="st">"a2_eudract_number"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Eliminate trials records duplicated by member state: </span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[ <span class="no">result</span><span class="kw">[[</span><span class="st">"_id"</span>]] <span class="kw">%in%</span>
                    <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>), ]

<span class="co"># Visualise:</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="no">result</span><span class="kw">[[</span><span class="st">"n_date_of_competent_authority_decision"</span>]],
     <span class="kw">breaks</span> <span class="kw">=</span> <span class="st">"years"</span>,
     <span class="kw">freq</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
     <span class="kw">las</span> <span class="kw">=</span> <span class="fl">1</span>); <span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span>()
<span class="co">#</span></pre></body></html></div>
<div class="figure">
<img src="Rplot01.png" alt=""><p class="caption">Histogram</p>
</div>
</div>
<div id="download-from-another-register-check-for-duplicates-merge-variables-and-re-organise-values" class="section level2">
<h2 class="hasAnchor">
<a href="#download-from-another-register-check-for-duplicates-merge-variables-and-re-organise-values" class="anchor"></a>Download from another register, check for duplicates, merge variables and re-organise values</h2>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co"># Ongoing phase 3 interventional trials in breast carcinoma</span>
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
  <span class="st">"https://clinicaltrials.gov/ct2/results?term=&amp;recr=Open&amp;"</span>,
  <span class="st">"type=Intr&amp;cond=breast+carcinoma&amp;intr=Drug&amp;state1=&amp;age=1&amp;phase=2"</span>)

<span class="co"># Show and check search in browser: </span>
<span class="fu"><a href="../reference/ctrOpenSearchPagesInBrowser.html">ctrOpenSearchPagesInBrowser</a></span>(<span class="no">q</span>)

<span class="co"># Count number of trials: </span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(
  <span class="no">q</span>,
  <span class="kw">only.count</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Load data: </span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(
  <span class="no">q</span>,
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Data from which queries have been downloaded into the database? </span>
<span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Get columns from the database from different registers</span>
<span class="fu"><a href="../reference/dbFindFields.html">dbFindFields</a></span>(<span class="st">"status"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"overall_status"</span>,
  <span class="st">"p_end_of_trial_status"</span>,
  <span class="st">"a2_eudract_number"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Find ids of unique trials if recorded by alternative countries or registers:</span>
<span class="no">ids_of_unique_trials</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">prefermemberstate</span> <span class="kw">=</span> <span class="st">"FR"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="no">ids_of_unique_trials</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">preferregister</span> <span class="kw">=</span> <span class="st">"EUCTR"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="no">ids_of_unique_trials</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">preferregister</span> <span class="kw">=</span> <span class="st">"CTGOV"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="co"># * Total of 2065 records in collection.</span>
<span class="co"># Searching for duplicates, found </span>
<span class="co">#  - 1516 EUCTR _id were not preferred EU Member State record of trial</span>
<span class="co">#  - 22 EUCTR _id in CTGOV secondary_id / nct_alias / org_study_id</span>
<span class="co">#  - 14 EUCTR a52_us_nct_... in CTGOV _id (nct)</span>
<span class="co">#  - 0 EUCTR a52_us_nct_... in CTOGV secondary_id / nct_alias / org_study_id</span>
<span class="co">#  - 0 EUCTR a51_isrctn_... in CTOGV secondary_id / nct_alias / org_study_id</span>
<span class="co">#  - 0 EUCTR a41_sponsors_protocol_... in CTOGV secondary_id / nct_alias / org_study_id</span>
<span class="co"># Concatenating 148 records from CTGOV and 359 from EUCTR:</span>
<span class="co"># = Returning keys (_id) of 507 out of total 2065 records in collection "some_collection_name"</span>

<span class="co"># Subset the result set to these unique trials:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[ <span class="no">result</span><span class="kw">[[</span><span class="st">"_id"</span>]] <span class="kw">%in%</span> <span class="no">ids_of_unique_trials</span>, ]

<span class="co"># Now merge two variables into a new variable for analysis:</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span>(
  <span class="no">result</span>,
  <span class="kw">colnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"overall_status"</span>,
               <span class="st">"p_end_of_trial_status"</span>))
<span class="co"># Unique values returned: Ongoing, Completed, Prematurely Ended, </span>
<span class="co"># Restarted, , Recruiting, Not yet recruiting</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">tmp</span>)
        <span class="co">#                     Completed Not yet recruiting            Ongoing</span>
        <span class="co">#          1                131                 27                184 </span>
        <span class="co"># Recruiting          Restarted     Prematurely Ended </span>
        <span class="co">#        121                  1                    42</span>

<span class="co"># Merge two variables as above and in addition, </span>
<span class="co"># condense their values into a new value:</span>
<span class="no">statusvalues</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="st">"ongoing"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Recruiting"</span>, <span class="st">"Active"</span>, <span class="st">"Ongoing"</span>,
                <span class="st">"Active, not recruiting"</span>,
                <span class="st">"Enrolling by invitation"</span>, <span class="st">"Restarted"</span>),
  <span class="st">"completed"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Completed"</span>, <span class="st">"Prematurely Ended"</span>, <span class="st">"Terminated"</span>),
  <span class="st">"other"</span>     <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Withdrawn"</span>, <span class="st">"Suspended"</span>, <span class="st">"No longer available"</span>,
                  <span class="st">"Not yet recruiting"</span>, <span class="st">"Temporarily Halted"</span>,
                  <span class="st">"Unknown status"</span>))

<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span>(
  <span class="no">result</span>,
  <span class="kw">colnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"overall_status"</span>,
               <span class="st">"p_end_of_trial_status"</span>),
  <span class="kw">levelslist</span> <span class="kw">=</span> <span class="no">statusvalues</span>)

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">tmp</span>)
<span class="co"># tmp</span>
        <span class="co">#   completed   ongoing     other </span>
        <span class="co"># 1       173       306        27 </span></pre></body></html></div>
</div>
<div id="use-a-remote-mongo-database" class="section level2">
<h2 class="hasAnchor">
<a href="#use-a-remote-mongo-database" class="anchor"></a>Use a remote mongo database</h2>
<p>This example works with a free service <a href="https://www.mongodb.com/cloud/atlas">here</a>. Note that the user name and password need to be encoded. The format of the connection string is documented <a href="https://docs.mongodb.com/manual/reference/connection-string/">here</a>.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co">## Specify base uri for remote mongodb server as part of the encoded connection string</span>
<span class="no">db</span> <span class="kw">&lt;-</span> <span class="kw pkg">nodbi</span><span class="kw ns">::</span><span class="fu"><a href="https://docs.ropensci.org/nodbi/reference/src_mongo.html">src_mongo</a></span>(
  <span class="kw">url</span> <span class="kw">=</span> <span class="st">"mongodb+srv://DWbJ7Wh:bdTHh5cS@cluster0-b9wpw.mongodb.net"</span>,
  <span class="kw">db</span> <span class="kw">=</span> <span class="st">"dbperm"</span>,
  <span class="kw">collection</span> <span class="kw">=</span> <span class="st">"dbperm"</span>)

<span class="co"># Database connection can just be used to retrieve data</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="kw">fields</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a2_eudract_number"</span>,
             <span class="st">"overall_status"</span>,
             <span class="st">"record_last_import"</span>,
             <span class="st">"primary_completion_date"</span>,
             <span class="st">"x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"</span>,
             <span class="st">"e71_human_pharmacology_phase_i"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)</pre></body></html></div>
</div>
<div id="use-another-package-for-analysis-for-example-count-sites-per-trial-with-mongolite" class="section level2">
<h2 class="hasAnchor">
<a href="#use-another-package-for-analysis-for-example-count-sites-per-trial-with-mongolite" class="anchor"></a>Use another package for analysis, for example count sites per trial with mongolite</h2>
<p>Note: Packages to access mango such as <code>mongolite</code> or <code>RMongo</code> may work to access data that are already in the mongo dababase. However, package <code>ctrdata</code> is still necessary to initially retrieve data from registers and to store these data into the database.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mongolite</span>)

<span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span>(
  <span class="kw">url</span> <span class="kw">=</span> <span class="st">"mongodb+srv://DWbJ7Wh:bdTHh5cS@cluster0-b9wpw.mongodb.net/dbperm"</span>,
  <span class="kw">collection</span> <span class="kw">=</span> <span class="st">"dbperm"</span>)

<span class="co"># List all collections:</span>
<span class="no">m</span>$<span class="fu">run</span>(<span class="st">'{"listCollections": 1}'</span>)

<span class="co"># Find the database elements that represent a site:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/r/utils/apropos.html">find</a></span>(<span class="st">'{}'</span>, <span class="st">'{"location.facility.name": 1}'</span>)

<span class="co"># Table by frequency</span>
<span class="no">tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rapply.html">rapply</a></span>(<span class="no">result</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>, <span class="kw">how</span> <span class="kw">=</span> <span class="st">"unlist"</span>))))
<span class="no">tbl</span> <span class="kw">&lt;-</span> <span class="no">tbl</span>[<span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">tbl</span>))]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">tbl</span>)
<span class="co">#                        Children's Hospital of Philadelphia </span>
<span class="co">#                                                          17 </span>
<span class="co">#               Cincinnati Children's Hospital Medical Center </span>
<span class="co">#                                                          14 </span>
<span class="co">#                                  Hospital for Sick Children </span>
<span class="co">#                                                          13 </span>
<span class="co">#                          Children's National Medical Center </span>
<span class="co">#                                                          13 </span>
<span class="co"># Children's Hospitals and Clinics of Minnesota - Minneapolis </span>
<span class="co">#                                                          13 </span>
<span class="co">#                              Nationwide Children's Hospital </span>
<span class="co">#                                                          11 </span>

<span class="co"># Define a helper function to count elements, irrespective of </span>
<span class="co"># whether the elements are in an array or are a set of </span>
<span class="co"># subdocuments in the database:</span>
<span class="no">count.elements</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">dataframecolumn</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">dataframecolumn</span>,
                <span class="kw">function</span>(<span class="no">x</span>)
                  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span>(<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">x</span><span class="kw">[[</span><span class="fl">1</span>]])),
                         <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">tmp</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">tmp</span>))))
}

<span class="co"># Sum up number of sites per trial:</span>
<span class="no">result</span>$<span class="no">number_of_sites</span> <span class="kw">&lt;-</span> <span class="fu">count.elements</span>(<span class="no">result</span>$<span class="no">location</span>)

<span class="co"># Inspect first rows:</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">result</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"_id"</span>, <span class="st">"number_of_sites"</span>)])
<span class="co">#                 _id number_of_sites</span>
<span class="co"># 1       NCT01471782              30</span>
<span class="co"># 2         meta-info               0</span>
<span class="co"># 3 2010-024264-18-DE               0</span>
<span class="co"># 4 2010-024264-18-AT               0</span>
<span class="co"># 5 2010-024264-18-NL               0</span>
<span class="co"># 6 2010-024264-18-IT               0</span>

<span class="co"># Draw histogram:</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="no">result</span>$<span class="no">number_of_sites</span>)</pre></body></html></div>
</div>
<div id="working-with-nested-data" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-nested-data" class="anchor"></a>Working with nested data</h2>
<p>Compare the way that fields (keys) may have to be specified differently for elements that are nested within other elements. See also <a href="#analyse-results-related-information">Analyse results-related information</a> below.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co"># - with MongoDB: finds all elements b31_and_b32_...</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="kw">fields</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="st">"b1_sponsor.b31_and_b32_status_of_the_sponsor"</span>, <span class="co"># Note dot path</span>
    <span class="st">"p_end_of_trial_status"</span>,
    <span class="st">"a2_eudract_number"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Eliminate trials records duplicated by EU Member State: </span>
<span class="no">uniqueids</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="no">result</span>    <span class="kw">&lt;-</span> <span class="no">result</span>[ <span class="no">result</span><span class="kw">[[</span><span class="st">"_id"</span>]] <span class="kw">%in%</span> <span class="no">uniqueids</span>, ]

<span class="co"># Tabulate the status of the clinical trial on the date of information retrieval</span>
<span class="co"># Note some trials have more than one sponsor and values are concatenated with /.</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">result</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">p_end_of_trial_status</span>,
                   <span class="no">b1_sponsor.b31_and_b32_status_of_the_sponsor</span>))
<span class="co">#                  b1_sponsor.b31_and_b32_status_of_the_sponsor</span>
<span class="co"># p_end_of_trial_status    Commercial  Non-Commercial  Non-Commercial / Non-Commercial</span>
<span class="co">#   Completed                      81              32                                0</span>
<span class="co">#   Ongoing                       205             239                               12</span>
<span class="co">#   Prematurely Ended              15              12                                0</span>
<span class="co">#   Restarted                       0               1                                0</span>
<span class="co">#   Temporarily Halted              4               1                                0</span>

<span class="co"># - with SQLite: finds the first, to retrieve </span>
<span class="co"># the second, increment to [1] and so on</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="kw">fields</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="st">"b1_sponsor[0].b31_and_b32_status_of_the_sponsor"</span>, <span class="co"># Note [0]</span>
    <span class="st">"p_end_of_trial_status"</span>,
    <span class="st">"a2_eudract_number"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># - with SQLite (and MongoDB): retrieve element at root</span>
<span class="co"># and extract its nested sub-elements later, using </span>
<span class="co"># the helper function that follows below. </span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="kw">fields</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"b1_sponsor"</span>,
             <span class="st">"p_end_of_trial_status"</span>,
             <span class="st">"a2_eudract_number"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Nested lists: its elements can be accessed </span>
<span class="co"># using the helper function getKeyNestedList()</span>
<span class="no">result</span><span class="kw">[[</span><span class="fl">1</span>, <span class="st">"b1_sponsor"</span>]]

<span class="co"># Example</span>
<span class="fu"><a href="../reference/dfListExtractKey.html">dfListExtractKey</a></span>(
  <span class="no">result</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"b1_sponsor"</span>,
         <span class="st">"b31_and_b32_status_of_the_sponsor"</span>)))</pre></body></html></div>
</div>
<div id="plot-frequency-of-certain-end-points" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-frequency-of-certain-end-points" class="anchor"></a>Plot frequency of certain end points</h2>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co"># Search for interesting variables,  </span>
<span class="co"># note the spelling in EUCTR:</span>
<span class="fu"><a href="../reference/dbFindFields.html">dbFindFields</a></span>(<span class="st">"end_point"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Get interesting variables from database </span>
<span class="co"># for further analysis within R:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"a2_eudract_number"</span>,
  <span class="st">"a41_sponsors_protocol_code_number"</span>,
  <span class="st">"n_date_of_competent_authority_decision"</span>,
  <span class="st">"e73_therapeutic_confirmatory_phase_iii"</span>,
  <span class="st">"e51_primary_end_points"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Eliminate trials records duplicated by member state</span>
<span class="co"># keep a single record and if available use preference:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[ <span class="no">result</span><span class="kw">[[</span><span class="st">"_id"</span>]] <span class="kw">%in%</span>
                  <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>), ]

<span class="co"># Checking expected number of trials:</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">result</span>)
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">result</span>$<span class="no">a2_eudract_number</span>))

<span class="co"># Only use phase 3 trials:</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">result</span>$<span class="no">e73_therapeutic_confirmatory_phase_iii</span>, <span class="kw">exclude</span> <span class="kw">=</span> <span class="st">""</span>)
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">result</span>$<span class="no">e73_therapeutic_confirmatory_phase_iii</span>, ]

<span class="co"># Is the a primary endpoint of interest? This uses regular expressions:</span>

<span class="co"># PFS / EFS / RFS / DFS</span>
<span class="no">result</span>$<span class="no">pe_is_efs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(
  <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"((progression|event|relapse|recurrence|disease)[- ]free)|pfs|dfs|efs)"</span>,
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">result</span>$<span class="no">e51_primary_end_points</span>,
  <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Plot:</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">result</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">n_date_of_competent_authority_decision</span>,
           <span class="kw">fill</span> <span class="kw">=</span> <span class="no">pe_is_efs</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">binwidth</span> <span class="kw">=</span> <span class="fl">365.25</span>)  +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Breast cancer phase 3 clinical trials"</span>,
       <span class="kw">x</span> <span class="kw">=</span> <span class="st">"Year of clinical trial authorisation in EU"</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Number of clinical trials"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Primary endpoint"</span>,
                    <span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"red"</span>, <span class="st">"green"</span>),
                    <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"FALSE"</span> <span class="kw">=</span> <span class="st">"Other"</span>, <span class="st">"TRUE"</span> <span class="kw">=</span> <span class="st">"PFS/EFS/DFS"</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span>  <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">vjust</span> <span class="kw">=</span> <span class="fl">0.5</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">date_breaks</span> <span class="kw">=</span> <span class="st">"1 year"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%Y"</span>)

<span class="co"># ggsave("vignettes/Rplot02.png", width = 6, height = 4)</span>

<span class="co"># Plausibility check - what is the primary endpoint</span>
<span class="co"># if not one of the endpoints of interest? </span>
<span class="co"># Look into first ten examples foundL</span>
<span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">result</span>$<span class="no">e51_primary_end_points</span>[<span class="no">result</span>$<span class="no">pe_is_efs</span> <span class="kw">==</span> <span class="fl">FALSE</span>], <span class="fl">1</span>, <span class="fl">60</span>)[<span class="fl">1</span>:<span class="fl">8</span>]
<span class="co"># [1] "Primary End point Overall survival: the interval between the"</span>
<span class="co"># [2] "To determine whether the combination of DPPE, epirubicin and"</span>
<span class="co"># [3] "Efficacy:  Duration of severe neutropenia DSN in cycle 1, de"</span>
<span class="co"># [4] NA                                                            </span>
<span class="co"># [5] "Hay dos variables principales de eficacia en este estudio: 1"</span>
<span class="co"># [6] "Time to progression TTP, defined as the interval between the"</span>
<span class="co"># [7] "Rate of pathological complete remissions in Arm A Epirubicin"</span>
<span class="co"># [8] "Survival, measured from the date of randomisation" </span></pre></body></html></div>
<div class="figure">
<img src="Rplot02.png" alt=""><p class="caption">Histogram2</p>
</div>
</div>
<div id="histogram-of-status-of-investigational-medicinal-product" class="section level2">
<h2 class="hasAnchor">
<a href="#histogram-of-status-of-investigational-medicinal-product" class="anchor"></a>Histogram of status of investigational medicinal product</h2>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(
  <span class="kw">register</span> <span class="kw">=</span> <span class="st">"EUCTR"</span>,
  <span class="kw">queryterm</span> <span class="kw">=</span> <span class="st">"&amp;age=under-18&amp;phase=phase-one&amp;phase=phase-two"</span>,
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu"><a href="../reference/ctrOpenSearchPagesInBrowser.html">ctrOpenSearchPagesInBrowser</a></span>(
  <span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>))

<span class="fu"><a href="../reference/dbFindFields.html">dbFindFields</a></span>(<span class="kw">namepart</span> <span class="kw">=</span> <span class="st">"phase"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)
<span class="co"># [1] "e72_therapeutic_exploratory_phase_ii"   "e71_human_pharmacology_phase_i"</span>
<span class="co"># [3] "e73_therapeutic_confirmatory_phase_iii" "e74_therapeutic_use_phase_iv"  </span>

<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a1_member_state_concerned"</span>, <span class="st">"n_date_of_competent_authority_decision"</span>,
    <span class="st">"dimp.d21_imp_to_be_used_in_the_trial_has_a_marketing_authorisation"</span>,
    <span class="st">"e11_medical_conditions_being_investigated"</span>, <span class="st">"e112_therapeutic_area"</span>,
    <span class="st">"e71_human_pharmacology_phase_i"</span>, <span class="st">"e72_therapeutic_exploratory_phase_ii"</span>,
    <span class="st">"x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"</span>,
    <span class="st">"f422_in_the_whole_clinical_trial"</span>,
    <span class="st">"a3_full_title_of_the_trial"</span>, <span class="st">"a2_eudract_number"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="no">searchfor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
  <span class="st">"cancer, leukaem, leukem, tumour, tumor, sarcoma, blastom, gliom, germ, "</span>,
  <span class="st">"lymphom, malign, hodgkin, ewing, rhabdo, terato, tumeur, leucemi"</span>)
<span class="no">searchfor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">searchfor</span>, <span class="st">", "</span>)<span class="kw">[[</span><span class="fl">1</span>]]

<span class="no">relevant</span> <span class="kw">&lt;-</span> <span class="fu">grepl_multi</span>(<span class="no">searchfor</span>, <span class="no">result</span>$<span class="no">a3_full_title_of_the_trial</span>) <span class="kw">|</span>
  <span class="fu">grepl_multi</span>(<span class="no">searchfor</span>, <span class="no">result</span>$<span class="no">e11_medical_conditions_being_investigated</span>) <span class="kw">|</span>
  <span class="fu">grepl_multi</span>(<span class="st">"C04"</span>,     <span class="no">result</span>$<span class="no">e112_therapeutic_area</span>)
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">relevant</span>)

<span class="co"># get relevant trials</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">relevant</span>,]
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">result</span>$<span class="no">e71_human_pharmacology_phase_i</span>,]

<span class="co"># find first member state to authorise trial</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="no">result</span>$<span class="no">n_date_of_competent_authority_decision</span>,
                 <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">result</span>$<span class="no">a2_eudract_number</span>),
                 <span class="kw">FUN</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">x</span>))
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">result</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">tmp</span>,
                <span class="kw">by.x</span> <span class="kw">=</span> <span class="st">"a2_eudract_number"</span>,
                <span class="kw">by.y</span> <span class="kw">=</span> <span class="st">"Group.1"</span>,
                <span class="kw">all.x</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># label date and calculate year</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">result</span>)[<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">result</span>)] <span class="kw">&lt;-</span> <span class="st">"startdatefirst"</span>
<span class="no">result</span>$<span class="no">startyearfirst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="no">result</span>$<span class="no">startdatefirst</span>, <span class="st">"%Y"</span>))

<span class="co"># eliminate country duplicates</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[ <span class="no">result</span><span class="kw">[[</span><span class="st">"_id"</span>]] <span class="kw">%in%</span>
                    <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(
                      <span class="kw">include3rdcountrytrials</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                      <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>), ]

<span class="co"># any of the investigational medicinal product(s) authorised or not?</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="kw pkg">stringi</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_count.html">stri_count</a></span>(
  <span class="no">result</span>$<span class="no">dimp.d21_imp_to_be_used_in_the_trial_has_a_marketing_authorisation</span>,
  <span class="kw">fixed</span> <span class="kw">=</span> <span class="st">"Yes"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">tmp</span>, <span class="kw">exclude</span> <span class="kw">=</span> <span class="st">""</span>)
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="no">tmp</span> <span class="kw">&gt;</span> <span class="fl">0</span>

<span class="co"># draw plot</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">result</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">startyearfirst</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">tmp</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">binwidth</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Paediatric phase 1 oncology trials in EU"</span>,
       <span class="kw">x</span> <span class="kw">=</span> <span class="st">"Year of trial authorisation (or EUCTR upload)"</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Number of trials"</span>,
       <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"Medicine\nauthorised?"</span>)

<span class="co"># save plot</span>
<span class="co"># ggsave("vignettes/phase1_paed_oncol.png", width = 6, height = 4)</span></pre></body></html></div>
<div class="figure">
<img src="phase1_paed_oncol.png" alt=""><p class="caption">Histogram3</p>
</div>
</div>
<div id="plot-map-of-ongoing-trials" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-map-of-ongoing-trials" class="anchor"></a>Plot map of ongoing trials</h2>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co"># this is to create a map of EU ongoing phase 1 trials with children with cancer on an anti-cancer medicine</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rworldmap</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">plyr</span>)

<span class="co"># get relevant variables from relevant collection</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a1_member_state_concerned"</span>, <span class="st">"n_date_of_competent_authority_decision"</span>,
    <span class="st">"e11_medical_conditions_being_investigated"</span>, <span class="st">"e112_therapeutic_area"</span>,
    <span class="st">"e71_human_pharmacology_phase_i"</span>, <span class="st">"e72_therapeutic_exploratory_phase_ii"</span>,
    <span class="st">"x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"</span>,
    <span class="st">"a3_full_title_of_the_trial"</span>, <span class="st">"a2_eudract_number"</span>, <span class="st">"p_end_of_trial_status"</span>,
    <span class="st">"ctrname"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># calculate country variable</span>
<span class="no">result</span>$<span class="no">country</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"^.+-([3A-Z]+)$"</span>, <span class="st">"\\1"</span>, <span class="no">result</span>$<span class="no">`_id`</span>)

<span class="co"># select trials of interest</span>
<span class="no">searchfor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
  <span class="st">"cancer, leukaem, leukem, tumour, tumor, sarcoma, blastom, gliom, germ, lymphom, "</span>,
  <span class="st">"malign, hodgkin, ewing, rhabdo, terato, tumeur, leucemi"</span>)
<span class="no">searchfor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">searchfor</span>, <span class="st">", "</span>)<span class="kw">[[</span><span class="fl">1</span>]]

<span class="no">relevant</span> <span class="kw">&lt;-</span> <span class="fu">grepl_multi</span>(<span class="no">searchfor</span>, <span class="no">result</span>$<span class="no">a3_full_title_of_the_trial</span>) <span class="kw">|</span>
  <span class="fu">grepl_multi</span>(<span class="no">searchfor</span>, <span class="no">result</span>$<span class="no">e11_medical_conditions_being_investigated</span>) <span class="kw">|</span>
  <span class="fu">grepl_multi</span>(<span class="st">"C04"</span>,     <span class="no">result</span>$<span class="no">e112_therapeutic_area</span>)

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">relevant</span>)

<span class="co"># apply selection criteria</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">relevant</span>,]
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">result</span>$<span class="no">e71_human_pharmacology_phase_i</span>,]
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">result</span>$<span class="no">ctrname</span> <span class="kw">==</span> <span class="st">"EUCTR"</span>,]
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[<span class="no">result</span>$<span class="no">country</span> <span class="kw">!=</span> <span class="st">"3RD"</span>,]

<span class="co"># get an overview</span>
<span class="no">counts</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame.matrix</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">result</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">country</span>, <span class="no">p_end_of_trial_status</span>)))

<span class="no">counts</span>$<span class="no">total</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">counts</span>)
<span class="no">counts</span>$<span class="no">country</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">counts</span>)
<span class="no">counts</span>$<span class="no">text</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">counts</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">Ongoing</span>, <span class="no">total</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"/"</span>))
<span class="no">counts</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span>(<span class="kw">filename</span> <span class="kw">=</span> <span class="st">"vignettes/ph1paedoncopen.png"</span>,
    <span class="kw">width</span> <span class="kw">=</span> <span class="fl">6</span>,
    <span class="kw">height</span> <span class="kw">=</span> <span class="fl">5</span>,
    <span class="kw">units</span> <span class="kw">=</span> <span class="st">"in"</span>,
    <span class="kw">res</span> <span class="kw">=</span> <span class="fl">300</span>)
<span class="no">sPDF</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rworldmap/man/joinCountryData2Map.html">joinCountryData2Map</a></span>(
  <span class="kw">dF</span> <span class="kw">=</span> <span class="no">counts</span>,
  <span class="kw">joinCode</span> <span class="kw">=</span> <span class="st">"ISO2"</span>,
  <span class="kw">nameJoinColumn</span> <span class="kw">=</span> <span class="st">"country"</span>)
<span class="no">mapParams</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rworldmap/man/mapCountryData.html">mapCountryData</a></span>(
  <span class="kw">mapToPlot</span> <span class="kw">=</span> <span class="no">sPDF</span>,
  <span class="kw">nameColumnToPlot</span> <span class="kw">=</span> <span class="st">"Ongoing"</span>,
  <span class="kw">mapTitle</span> <span class="kw">=</span> <span class="st">""</span>,
  <span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">10</span>,<span class="fl">30</span>),
  <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">36</span>, <span class="fl">65</span>),
  <span class="kw">addLegend</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">colourPalette</span> <span class="kw">=</span> <span class="st">"terrain"</span>)
<span class="co"># do.call(addMapLegend, c(mapParams, legendLabels="all", </span>
<span class="co"># legendWidth=0.5, digits=0, labelFontSize=0.8))</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="kw">main</span> <span class="kw">=</span> <span class="st">"Number of ongoing / total phase 1\nanti-cancer medicine trials with children"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/rworldmap/man/labelCountries.html">labelCountries</a></span>(
  <span class="kw">dF</span> <span class="kw">=</span> <span class="no">sPDF</span>,
  <span class="kw">nameCountryColumn</span> <span class="kw">=</span> <span class="st">"text"</span>,
  <span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">15</span>,<span class="fl">32</span>),
  <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">36</span>, <span class="fl">65</span>),
  <span class="kw">cex</span> <span class="kw">=</span> <span class="fl">0.9</span>,
  <span class="kw">col</span> <span class="kw">=</span> <span class="st">"blue"</span>)
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>()</pre></body></html></div>
<div class="figure">
<img src="ph1paedoncopen.png" alt=""><p class="caption">Histogram3</p>
</div>
</div>
<div id="use-aggregation-functions-of-the-data-base-to-find-specific-trial-endpoints" class="section level2">
<h2 class="hasAnchor">
<a href="#use-aggregation-functions-of-the-data-base-to-find-specific-trial-endpoints" class="anchor"></a>Use aggregation functions of the data base to find specific trial endpoints</h2>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mongolite</span>)

<span class="co"># Link R object m to the specified database collection:</span>
<span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span>(<span class="kw">url</span> <span class="kw">=</span> <span class="st">"mongodb://localhost/users"</span>,
           <span class="kw">collection</span> <span class="kw">=</span> <span class="st">"ctrdata"</span>)

<span class="co"># List all collections:</span>
<span class="no">m</span>$<span class="fu">run</span>(<span class="st">'{"listCollections": 1}'</span>)

<span class="co"># Number of all records in this collection:</span>
<span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/pkg/plyr/man/count.html">count</a></span>()

<span class="co"># Number of EUCTR records, using json for query:</span>
<span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/pkg/plyr/man/count.html">count</a></span>(<span class="kw">query</span> <span class="kw">=</span> <span class="st">'{"_id": {"$regex": "[0-9]{4}-[0-9]{6}-[0-9]{2}", 
                 "$options": "i"}}'</span>)
<span class="co"># alternatively: </span>
<span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/pkg/plyr/man/count.html">count</a></span>(<span class="kw">query</span> <span class="kw">=</span> <span class="st">'{"ctrname": "EUCTR"}'</span>)

<span class="co"># Number of CTGOV records, using json for query:</span>
<span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/pkg/plyr/man/count.html">count</a></span>(<span class="kw">query</span> <span class="kw">=</span> <span class="st">'{"_id": {"$regex": "NCT[0-9]{8}", "$options": "i"}}'</span>)
<span class="co"># alternatively:</span>
<span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/pkg/plyr/man/count.html">count</a></span>(<span class="kw">query</span> <span class="kw">=</span> <span class="st">'{"ctrname": "CTGOV"}'</span>)

<span class="co"># The following uses the aggregation pipeline in mongo:</span>
<span class="co">#</span>
<span class="co"># Count number of records in which certain terms occur,</span>
<span class="co"># in any of the elements of the array in primary_outcome. </span>
<span class="co"># Regular expressions ("$regex") are case insensitive ("i")</span>
<span class="co">#</span>
<span class="co"># See here for details on mongo's aggregation pipleline: </span>
<span class="co"># https://docs.mongodb.org/manual/core/aggregation-pipeline/</span>

<span class="co"># Recommendation: to best define regular expressions for analyses, </span>
<span class="co"># inspect the field primary_outcome.measure in database, or print:</span>
<span class="no">m</span>$<span class="fu">distinct</span>(<span class="kw">key</span> <span class="kw">=</span> <span class="st">"primary_outcome.measure"</span>,
           <span class="kw">query</span> <span class="kw">=</span> <span class="st">'{"_id": {"$regex": "NCT[0-9]{8}", "$options": "i"}}'</span>)[<span class="fl">1</span>:<span class="fl">8</span>]

<span class="co"># PFS, EFS, RFS or DFS</span>
<span class="no">out</span> <span class="kw">&lt;-</span> <span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(
  <span class="kw">pipeline</span> <span class="kw">=</span>
    <span class="st">'[{"$match": {"primary_outcome.measure": 
      {"$regex": "(progression|event|relapse|recurrence|disease)[- ]free", 
                 "$options": "i"}}}, 
      {"$group": {"_id": "null", "count": {"$sum": 1}}}]'</span>)
<span class="no">out</span>

<span class="co"># OS by year</span>
<span class="no">out</span> <span class="kw">&lt;-</span> <span class="no">m</span>$<span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(
  <span class="kw">pipeline</span> <span class="kw">=</span>
    <span class="st">'[{"$match": {"primary_outcome.measure": 
      {"$regex": "overall survival", "$options": "i"}}}, 
      {"$project": {"_id": 1, "start_date": 1}}]'</span>)

<span class="no">out</span>
<span class="co">#           _id        start_date</span>
<span class="co"># 1 NCT00796510         July 2010</span>
<span class="co"># 2 NCT01083706        April 2010</span>
<span class="co"># 3 NCT01141712        April 2010</span>
<span class="co"># 4 NCT01343277         June 2011</span>
<span class="co"># 5 NCT01696045 November 12, 2012</span>
<span class="co"># 6 NCT00553202      January 2008</span>
<span class="co"># 7 NCT00653068     December 2008</span>
<span class="co"># 8 NCT00684996         June 2008</span>

<span class="co"># Extraction of year from firstreceived_date </span>
<span class="co"># such as "August 29, 2009"</span>
<span class="no">out</span>$<span class="no">year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(
  <span class="no">out</span>$<span class="no">start_date</span>,
  <span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span>(<span class="no">out</span>$<span class="no">start_date</span>) - <span class="fl">4</span>,
  <span class="no">tmp</span> + <span class="fl">4</span>)
<span class="co">#</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">out</span>$<span class="no">year</span>)
<span class="co"># [...]  2006  2007  2008  2009  2010  2011  2012  2013  2014  2015 </span>
<span class="co">#           5     4    13     3     8     3     8     4     6     6 </span></pre></body></html></div>
</div>
<div id="use-mapreduce-operations-to-analyse-participant-numbers" class="section level2">
<h2 class="hasAnchor">
<a href="#use-mapreduce-operations-to-analyse-participant-numbers" class="anchor"></a>Use mapreduce operations to analyse participant numbers</h2>
<p>Note that the mongodb documentation includes that a mapreduce operation might not be as fast and efficient as using the aggregation pipeline, which was used in the preceding example.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mongolite</span>)

<span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span>(<span class="kw">url</span> <span class="kw">=</span> <span class="st">"mongodb://localhost/users"</span>,
           <span class="kw">collection</span> <span class="kw">=</span> <span class="st">"ctrdata"</span>)

<span class="co"># Count number of trials (trial records) with number of</span>
<span class="co"># study participants in bins of hundreds of participants:</span>
<span class="no">hist</span> <span class="kw">&lt;-</span> <span class="no">m</span>$<span class="fu">mapreduce</span>(
  <span class="kw">map</span> <span class="kw">=</span> <span class="st">"function(){emit(Math.floor(this.f422_in_the_whole_clinical_trial/100)*100, 1)}"</span>,
  <span class="kw">reduce</span> <span class="kw">=</span> <span class="st">"function(id, counts){return Array.sum(counts)}"</span>
)

<span class="no">hist</span>
<span class="co">#      _id value</span>
<span class="co"># 1    NaN  1431</span>
<span class="co"># 2      0   140</span>
<span class="co"># 3    100   128</span>
<span class="co"># 4    200   157</span>
<span class="co"># 5    300   141</span>
<span class="co"># 6    400   183</span>
<span class="co"># 7    500   176</span>
<span class="co"># 8    600   249</span>
<span class="co"># 9    700   169</span>
<span class="co"># 10   800    60</span>
<span class="co"># 11   900    61</span>

<span class="co"># Note: _id is the bin of hundreds of study participants, </span>
<span class="co"># value is the number of studies in respective bin</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">hist</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"h"</span>, <span class="kw">las</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">2000</span>), <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">500</span>),
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Number stubjects"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Number of trials"</span>)</pre></body></html></div>
<div class="figure">
<img src="Rplot03.png" alt=""><p class="caption">Histogram2</p>
</div>
</div>
<div id="analyse-inclusion-criteria" class="section level2">
<h2 class="hasAnchor">
<a href="#analyse-inclusion-criteria" class="anchor"></a>Analyse inclusion criteria</h2>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="co"># Search for interesting variables,  </span>
<span class="co"># note the spelling in EUCTR:</span>
<span class="fu"><a href="../reference/dbFindFields.html">dbFindFields</a></span>(<span class="kw">namepart</span> <span class="kw">=</span> <span class="st">"crit"</span>, <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Get interesting variables from database </span>
<span class="co"># for further analysis within R:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"e3_principal_inclusion_criteria"</span>,
    <span class="st">"eligibility.criteria.textblock"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Eliminate trials records duplicated by member state</span>
<span class="co"># keep a single record and if available use preference:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="no">result</span>[ <span class="no">result</span><span class="kw">[[</span><span class="st">"_id"</span>]] <span class="kw">%in%</span>
                    <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span>(<span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>), ]

<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span>(
  <span class="kw">df</span> <span class="kw">=</span> <span class="no">result</span>,
  <span class="kw">colnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"e3_principal_inclusion_criteria"</span>,
               <span class="st">"eligibility.criteria.textblock"</span>))

<span class="co"># search for interesting terms</span>
<span class="no">terms</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"positive"</span>, <span class="st">"marker"</span>, <span class="st">"select"</span>)

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu">grepl_multi</span>(<span class="no">terms</span>, <span class="no">result</span>))

<span class="co"># utility function to generate a regular expression </span>
<span class="co"># for a given number of words</span>
<span class="no">words</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"\\s+\\w+"</span>, <span class="no">x</span>), <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">""</span>), <span class="st">"\\s+"</span>)

<span class="no">terms</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">".*("</span>, <span class="fu">words</span>(<span class="fl">2</span>), <span class="no">terms</span>, <span class="st">"\\w*"</span>, <span class="fu">words</span>(<span class="fl">3</span>), <span class="st">").*"</span>)

<span class="co"># find and print found matches for review</span>
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">terms</span>))
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="no">terms</span>[<span class="no">i</span>], <span class="st">"\\1"</span>,
             <span class="no">result</span>,
             <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>)[<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="no">terms</span>[<span class="no">i</span>], <span class="no">result</span>)])
 <span class="co">#  [1] " Those with positive sentinel nodes must "                     </span>
 <span class="co">#  [2] " Those with positive sentinel nodes must "                     </span>
 <span class="co">#  [3] " 10 receptor positive cells or 10fmol "                        </span>
 <span class="co">#  [4] " have a positive PPD skin test "                               </span>
 <span class="co">#  [5] " tumor cells positive by immunohistochemical evaluation  "     </span>
 <span class="co">#  [6] " Hormone receptor positive defined as ER "                     </span>
 <span class="co">#  [7] " or PgR positive 5 Women with "                                </span>
 <span class="co">#  [8] " Hormone receptor positive defined as ER "                     </span>
 <span class="co">#  [9] " Has a positive skin prick test "                              </span>
 <span class="co"># [10] " inhibitors a positive inhibitor status defined " </span></pre></body></html></div>
</div>
<div id="find-trial-start-date" class="section level2">
<h2 class="hasAnchor">
<a href="#find-trial-start-date" class="anchor"></a>Find trial start date</h2>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="co"># Get interesting variables from database </span>
<span class="co"># for further analysis within R:</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a2_eudract_number"</span>,
    <span class="st">"n_date_of_competent_authority_decision"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># Calculate first date of trial start</span>
<span class="no">first_trial_start</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">result</span>$<span class="no">n_date_of_competent_authority_decision</span>,
  <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">result</span>$<span class="no">a2_eudract_number</span>),
  <span class="kw">FUN</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">x</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
  <span class="kw">simplify</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">drop</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Give data frame appropriate names:</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">first_trial_start</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a2_eudract_number"</span>,
                              <span class="st">"first_trial_start_date"</span>)

<span class="co"># Merge back into result set: </span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="no">result</span>, <span class="no">first_trial_start</span>, <span class="kw">all.x</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
</div>
<div id="annotate-records-when-using-ctrloadintodb-with-user-text" class="section level2">
<h2 class="hasAnchor">
<a href="#annotate-records-when-using-ctrloadintodb-with-user-text" class="anchor"></a>Annotate records when using ctrLoadIntoDb() with user text</h2>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(
  <span class="kw">queryterm</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://clinicaltrials.gov/ct2/results?"</span>,
                     <span class="st">"age=0&amp;intr=dasatinib&amp;phase=1"</span>),
  <span class="kw">annotation.text</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"|AS:"</span>, <span class="st">"dasatinib"</span>, <span class="st">"|"</span>),
  <span class="kw">annotation.mode</span> <span class="kw">=</span> <span class="st">"prepend"</span>,
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co"># helper function</span>
<span class="no">getannotationelement</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">element</span> <span class="kw">=</span> <span class="st">"AS"</span>) {

  <span class="co"># example from annotation.text: </span>
  <span class="co"># x &lt;- "|AS:tisagenlecleucel| |AS:dasatinib|"</span>

  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">split</span> <span class="kw">=</span> <span class="st">"\\|"</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span>[<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"^"</span>, <span class="no">element</span>, <span class="st">":"</span>), <span class="no">x</span>)]
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">split</span> <span class="kw">=</span> <span class="st">":"</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">x</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span>[!<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"AS"</span>, <span class="no">x</span>)]
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">x</span>))

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x</span>)
}

<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="kw">fields</span> <span class="kw">=</span> <span class="st">"annotation"</span>,
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="fu">getannotationelement</span>(
  <span class="no">result</span>$<span class="no">annotation</span>,
  <span class="kw">element</span> <span class="kw">=</span> <span class="st">"AS"</span>)
<span class="co"># [1] "dasatinib"</span></pre></body></html></div>
</div>
<div id="analyse-results-related-information" class="section level2">
<h2 class="hasAnchor">
<a href="#analyse-results-related-information" class="anchor"></a>Analyse results-related information</h2>
<p>Distribution of p values</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="co">## get trials into database</span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span>(
  <span class="kw">queryterm</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
    <span class="st">"https://clinicaltrials.gov/ct2/results?rslt=With&amp;age=0&amp;intr=Drug&amp;"</span>,
    <span class="st">"phase=1&amp;phase=2&amp;strd_s=01%2F01%2F2010&amp;strd_e=12%2F31%2F2012"</span>),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>)

<span class="co">## get result set</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"start_date"</span>,
    <span class="st">"detailed_description.textblock"</span>,
    <span class="st">"official_title"</span>,
    <span class="st">"eligibility.maximum_age"</span>,
    <span class="st">"study_design_info.allocation"</span>,
    <span class="st">"primary_outcome.measure"</span>,
    <span class="st">"arm_group.arm_group_type"</span>,
    <span class="st">"clinical_results.outcome_list.outcome.analysis_list.analysis.method"</span>,
    <span class="st">"clinical_results.outcome_list.outcome.analysis_list.analysis.p_value"</span>,
    <span class="st">"clinical_results.outcome_list.outcome.analysis_list.analysis.param_type"</span>,
    <span class="st">"clinical_results.outcome_list.outcome.analysis_list.analysis.non_inferiority_type"</span>,
    <span class="st">"clinical_results.baseline.analyzed_list.analyzed.units"</span>,
    <span class="st">"clinical_results.baseline.analyzed_list.analyzed.count_list.count.@attributes.value"</span>
  ),
  <span class="kw">con</span> <span class="kw">=</span> <span class="no">db</span>,
  <span class="kw">stopifnodata</span> <span class="kw">=</span> <span class="fl">FALSE</span>)


<span class="co">## count number of participants per trial</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu">simplifyList</span>(
  <span class="no">result</span>[,
    <span class="st">"clinical_results.baseline.analyzed_list.analyzed.count_list.count.@attributes.value"</span>])

<span class="co"># change into number and sum up per trial</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">x</span>), <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>))

<span class="co"># check that unit of first analysis is participants, not e.g. wounds or eyes</span>
<span class="no">tmpparticipants</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">result</span>$<span class="no">clinical_results.baseline.analyzed_list.analyzed.units</span>,
                          <span class="kw">function</span>(<span class="no">x</span>) (<span class="no">x</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="kw">==</span> <span class="st">"Participants"</span>)[<span class="fl">1</span>])


<span class="co">## p value for endpoint analysis</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu">simplifyList</span>(
  <span class="no">result</span>[, <span class="st">"clinical_results.outcome_list.outcome.analysis_list.analysis.p_value"</span>])

<span class="co"># get first p-value (first analysis primary endpoint)</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="st">"[["</span>, <span class="fl">1</span>)

<span class="co"># replace empty list elements with NA</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x</span>), <span class="no">x</span>, <span class="fl">NA</span>))

<span class="co"># turn strings into numbers, see helper function</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="kw">FUN</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu">normalise_number</span>(<span class="no">x</span>))

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">tmp</span>)

<span class="no">result</span>$<span class="no">pvalueprimaryanalysis</span> <span class="kw">&lt;-</span> <span class="no">tmp</span>


<span class="co">## statistical method used for primary endpoint analysis</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu">simplifyList</span>(
  <span class="no">result</span>[<span class="st">"clinical_results.outcome_list.outcome.analysis_list.analysis.method"</span>])

<span class="co"># get first method (first analysis primary endpoint)</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="st">"[["</span>, <span class="fl">1</span>)

<span class="co"># replace empty list elements with NA</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x</span>), <span class="no">x</span>, <span class="fl">NA</span>))

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">tmp</span>)

<span class="no">result</span>$<span class="no">methodprimaryanalysis</span> <span class="kw">&lt;-</span> <span class="no">tmp</span>


<span class="co">## Based on allocation arms, keep trials that are likely to investigate </span>
<span class="co">## safety and efficacy considering that active comparators may not be </span>
<span class="co">## designed to show superiority. </span>
<span class="co"># controlled?</span>
<span class="no">result</span>$<span class="no">control</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"(Placebo|No Intervention)"</span>,
                        <span class="no">result</span>$<span class="no">arm_group.arm_group_type</span>,
                        <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">result</span>$<span class="no">control</span>)
<span class="co"># randomised?</span>
<span class="no">result</span>$<span class="no">randomised</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"^Randomi.*"</span>,
                           <span class="no">result</span>$<span class="no">study_design_info.allocation</span>,
                           <span class="kw">ignore.case</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">result</span>$<span class="no">randomised</span>)
<span class="co"># two or more arms?</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu">simplifyList</span>(<span class="no">result</span>[<span class="st">"arm_group.arm_group_type"</span>])
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">tmp</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">x</span>)) <span class="kw">&gt;=</span> <span class="fl">2</span>)
<span class="no">result</span>$<span class="no">twoormoregroups</span> <span class="kw">&lt;-</span> <span class="no">tmp</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">result</span>, <span class="no">control</span> <span class="kw">&amp;</span> <span class="no">randomised</span> <span class="kw">&amp;</span> <span class="no">twoormoregroups</span>)


<span class="co">## plot p values</span>
<span class="co"># http://varianceexplained.org/statistics/interpreting-pvalue-histogram/</span>
<span class="co"># http://www.pnas.org/content/100/16/9440.full</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">result</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">pvalueprimaryanalysis</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Paediatric phase 2 or 3 interventional trials\n"</span>,
                      <span class="st">"with randomisation to placebo or to no intervention"</span>),
       <span class="kw">x</span> <span class="kw">=</span> <span class="st">"p value in primary endpoint primary analysis"</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Empirical cumulative density of trials"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="fl">0.05</span>,
                 <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"red"</span>),
             <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ecdf.html">stat_ecdf</a></span>(<span class="kw">geom</span> <span class="kw">=</span> <span class="st">"step"</span>)
<span class="co"># ggsave("vignettes/ctrdatapvaluesphase23.png", width = 6, height = 4)</span>

<span class="co">## statistical method used for primary endpoint analysis</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">result</span>$<span class="no">methodprimaryanalysis</span>)
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="no">tmp</span>[<span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">tmp</span>))]
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">tmp</span>)
<span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">tmp</span>[<span class="fl">1</span>:<span class="fl">10</span>,])</pre></body></html></div>
<div class="figure">
<img src="ctrdatapvaluesphase23.png" alt=""><p class="caption">ECDFpvalues</p>
</div>
<table class="table">
<thead><tr class="header">
<th align="left">Var1</th>
<th align="right">Freq</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ANCOVA</td>
<td align="right">40</td>
</tr>
<tr class="even">
<td align="left">Cochran-Mantel-Haenszel</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="left">Mixed Models Analysis</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="left">ANOVA</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="left">t-test, 2 sided</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">Fisher Exact</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">Chi-squared</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">Regression, Logistic</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Log Rank</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Wilcoxon (Mann-Whitney)</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ralf Herold.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'c06ec790dbbaffba8e7b188f745a4353',
    indexName: 'ctrdata',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
