<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analysing clinical trial information • ctrdata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Analysing clinical trial information">
<meta property="og:description" content="ctrdata">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@rfhb">
<meta name="twitter:site" content="@rfhb">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctrdata</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.4.1.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ctrdata_analyse.html">Analysing clinical trial information</a>
    </li>
    <li>
      <a href="../articles/ctrdata_install.html">Install R package ctrdata</a>
    </li>
    <li>
      <a href="../articles/ctrdata_retrieve.html">Retrieve clinical trial information</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rfhb/ctrdata/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ctrdata_analyse_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Analysing clinical trial information</h1>
                        <h4 class="author">Ralf Herold</h4>
            
            <h4 class="date">2020-10-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rfhb/ctrdata/blob/master/vignettes/ctrdata_analyse.Rmd"><code>vignettes/ctrdata_analyse.Rmd</code></a></small>
      <div class="hidden name"><code>ctrdata_analyse.Rmd</code></div>

    </div>

    
    
<p>General information on the <code>ctrdata</code> package is available here: <a href="https://github.com/rfhb/ctrdata">https://github.com/rfhb/ctrdata</a>.</p>
<p>Remember to respect the registers’ terms and conditions (see <code><a href="../reference/ctrOpenSearchPagesInBrowser.html">ctrOpenSearchPagesInBrowser(copyright = TRUE)</a></code>). Please cite this package in any publication as follows: Ralf Herold (2020). ctrdata: Retrieve and Analyze Clinical Trials in Public Registers. R package version 1.4, <a href="https://cran.r-project.org/package=ctrdata" class="uri">https://cran.r-project.org/package=ctrdata</a></p>
<div id="preparations" class="section level1">
<h1 class="hasAnchor">
<a href="#preparations" class="anchor"></a>Preparations</h1>
<p>Here using MongoDB, which is faster than SQLite, can handle credentials, provides access to remote servers and can directly retrieve nested elements from paths. See <a href="../README.html">README.md</a> and <a href="ctrdata_retrieve.Rmd">Retrieve clinical trial information</a> for examples using SQLite.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">nodbi</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/nodbi/reference/src_mongo.html">src_mongo</a></span><span class="op">(</span>
  url <span class="op">=</span> <span class="st">"mongodb://localhost"</span>,
  db <span class="op">=</span> <span class="st">"some_database_name"</span>,
  collection <span class="op">=</span> <span class="st">"some_collection_name"</span><span class="op">)</span>
<span class="va">db</span>
<span class="co"># MongoDB 3.6.8 (uptime: 244492s)</span>
<span class="co"># URL: laptop.home/some_database_name </span>
<span class="co"># Collection: some_collection_name</span></code></pre></div>
<p>See <a href="ctrdata_retrieve.Rmd">Retrieve clinical trial information</a> for more details.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=ctrdata">ctrdata</a></span><span class="op">)</span>

<span class="co"># These two queries are equivalent, for </span>
<span class="co"># completed interventional (drug) trials </span>
<span class="co"># with children with a neuroblastoma</span>
<span class="co"># from either register. </span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span><span class="op">(</span>
  <span class="co"># using queryterm and register ...</span>
  queryterm <span class="op">=</span> <span class="st">"query=neuroblastoma&amp;age=under-18&amp;status=completed"</span>, 
  register <span class="op">=</span> <span class="st">"EUCTR"</span>,
  euctrresults <span class="op">=</span> <span class="cn">TRUE</span>,
  con <span class="op">=</span> <span class="va">db</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb</a></span><span class="op">(</span>
  <span class="co"># ... or using full url of search results</span>
  queryterm <span class="op">=</span> 
    <span class="st">"https://clinicaltrials.gov/ct2/results?cond=neuroblastoma&amp;recrs=e&amp;age=0&amp;intr=Drug"</span>, 
  con <span class="op">=</span> <span class="va">db</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/dbQueryHistory.html">dbQueryHistory</a></span><span class="op">(</span>con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>
<span class="co">#       query-timestamp query-register query-records</span>
<span class="co"># 1 2020-10-11 22:11:49          EUCTR           128</span>
<span class="co"># 2 2020-10-11 22:12:08          CTGOV           190</span></code></pre></div>
</div>
<div id="find-fields-variables-of-interest" class="section level1">
<h1 class="hasAnchor">
<a href="#find-fields-variables-of-interest" class="anchor"></a>Find fields / variables of interest</h1>
<p>Specify a part of the name of a variable of interest; all variables including deeply nested variable names are searched.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/dbFindFields.html">dbFindFields</a></span><span class="op">(</span>namepart <span class="op">=</span> <span class="st">"date"</span>, con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>
<span class="co"># Finding fields in database (may take some time)</span>
<span class="co"># Field names cached for this session.</span>
<span class="co">#  [1] "completion_date"                                                                  </span>
<span class="co">#  [2] "e231_full_title_date_and_version_of_each_substudy_and_their_related_objectives"   </span>
<span class="co">#  [3] "e231_full_title_date_and_version_of_each_substudy_and_their_related_objectives_es"</span>
<span class="co">#  [4] "last_update_posted"                                                               </span>
<span class="co">#  [5] "last_update_submitted"                                                            </span>
<span class="co">#  [6] "last_update_submitted_qc"                                                         </span>
<span class="co">#  [7] "n_date_of_competent_authority_decision"                                           </span>
<span class="co">#  [8] "n_date_of_ethics_committee_opinion"                                               </span>
<span class="co">#  [9] "p_date_of_the_global_end_of_the_trial"                                            </span>
<span class="co"># [10] "primary_completion_date"                                                          </span>
<span class="co"># [11] "provided_document_section.provided_document.document_date"                        </span>
<span class="co"># [12] "required_header.download_date"                                                    </span>
<span class="co"># [13] "start_date"                                                                       </span>
<span class="co"># [14] "verification_date"                                                                </span>
<span class="co"># [15] "x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"</span></code></pre></div>
<p>The search for fields is cached and thus accelerated during the R session, as long as no new <code><a href="../reference/ctrLoadQueryIntoDb.html">ctrLoadQueryIntoDb()</a></code> is executed.</p>
</div>
<div id="data-frame-from-database" class="section level1">
<h1 class="hasAnchor">
<a href="#data-frame-from-database" class="anchor"></a>Data frame from database</h1>
<p>The fields of interest can be obtained from the database and are represented in an R data.frame:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"f41_in_the_member_state"</span>, 
    <span class="st">"f422_in_the_whole_clinical_trial"</span>,
    <span class="st">"a1_member_state_concerned"</span>, 
    <span class="st">"p_end_of_trial_status"</span>,
    <span class="st">"n_date_of_competent_authority_decision"</span>, 
    <span class="st">"a2_eudract_number"</span>,
    <span class="st">"overall_status"</span>,
    <span class="st">"start_date"</span>,
    <span class="st">"primary_completion_date"</span><span class="op">)</span>, 
  con <span class="op">=</span> <span class="va">db</span><span class="op">)</span></code></pre></div>
</div>
<div id="metadata-from-data-frame" class="section level1">
<h1 class="hasAnchor">
<a href="#metadata-from-data-frame" class="anchor"></a>Metadata from data frame</h1>
<p>The objects returned by functions of this package include attributes with metadata to indicate from which database, table / collection and query details. Metadata can be reused in R.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span>
  <span class="va">result</span>
<span class="op">)</span>
<span class="co"># $`ctrdata-dbname`</span>
<span class="co"># [1] "some_database_name"</span>
<span class="co"># </span>
<span class="co"># $`ctrdata-table`</span>
<span class="co"># [1] "some_collection_name"</span>
<span class="co"># </span>
<span class="co"># $`ctrdata-dbqueryhistory`</span>
<span class="co">#       query-timestamp query-register query-records</span>
<span class="co"># 1 2020-10-12 22:11:49          EUCTR           128</span>
<span class="co"># 2 2020-10-12 22:12:08          CTGOV           190</span>
<span class="co">#                                          query-term</span>
<span class="co"># 1 query=neuroblastoma&amp;age=under-18&amp;status=completed</span>
<span class="co"># 2        cond=neuroblastoma&amp;recrs=e&amp;age=0&amp;intr=Drug</span></code></pre></div>
<p>In the database, the variable "_id" is the unique index for a record. This "_id" is the NCT number for CTGOV records (e.g., “NCT00002560”), and it is the EudraCT number for EUCTR records including the postfix identifying the EU Member State (e.g., “2008-001436-12-NL”).</p>
<p>It is relevant to de-duplicate records because a trial can be registered in both CTGOV and EUCTR, and can have records by involved country in EUCTR.</p>
<p>De-duplication is done at the analysis stage because this enables to select if a trial record should be taken from one or the other register, and from one or the other EU Member State.</p>
<p>The basis of de-duplication is the recording of additional trial identifiers in supplementary fields (variables), which are checked and reported when using function <code><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Obtain de-duplicate trial record ids</span>
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span><span class="op">(</span>
  preferregister <span class="op">=</span> <span class="st">"EUCTR"</span>,
  con <span class="op">=</span> <span class="va">db</span>
<span class="op">)</span>
<span class="co"># * Total of 318 records in collection.</span>
<span class="co"># Searching for duplicates, found </span>
<span class="co">#  - 93 EUCTR _id were not preferred EU Member State record of trial</span>
<span class="co">#  - 3 CTGOV _id (nct) in EUCTR a52_us_nct_...</span>
<span class="co">#  - 5 CTGOV secondary_id / nct_alias / org_study_id in EUCTR a2_eudract_number</span>
<span class="co">#  - 0 CTGOV secondary_id / nct_alias / org_study_id in EUCTR a52_us_nct_...</span>
<span class="co">#  - 0 CTGOV secondary_id / nct_alias / org_study_id in EUCTR a51_isrctn_...</span>
<span class="co">#  - 10 CTGOV secondary_id / nct_alias / org_study_id in EUCTR a41_sponsors_protocol_...</span>
<span class="co"># Concatenating 35 records from EUCTR and 179 from CTGOV:</span>
<span class="co"># = Returning keys (_id) of 214 out of total 318 records in collection "some_collection_name".</span></code></pre></div>
<p>The unique ids can be used like this to de-duplicate the data.frame created above:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Eliminate duplicate trials records: </span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span> <span class="va">result</span><span class="op">[[</span><span class="st">"_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">%in%</span> <span class="va">ids</span>, <span class="op">]</span>
<span class="co">#</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="co"># [1] 214</span></code></pre></div>
</div>
<div id="simple-analysis---dates" class="section level1">
<h1 class="hasAnchor">
<a href="#simple-analysis---dates" class="anchor"></a>Simple analysis - dates</h1>
<p>In a data.frame generated with <code><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf()</a></code>, fields are typed as dates, logical and numbers.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="co"># $ _id                                    : "2005-001267-63-IT" "2005-002089-13-GB" ...</span>
<span class="co"># $ f41_in_the_member_state                : int  NA 15 5 37 NA 24 100 NA 600 24 ...</span>
<span class="co"># $ f422_in_the_whole_clinical_trial       : int  230 63 12 67 70 NA 100 156 2230 NA ...</span>
<span class="co"># $ a1_member_state_concerned              : chr  "Italy - Italian Medicines Agency"</span>
<span class="co"># $ p_end_of_trial_status                  : chr  "Completed" "Completed" ...</span>
<span class="co"># $ n_date_of_competent_authority_decision : Date, format: "2005-06-02" "2005-09-06" ...</span>
<span class="co"># $ a2_eudract_number                      : chr  "2005-001267-63" "2005-002089-13" ...</span>
<span class="co"># $ overall_status                         : chr  NA NA NA NA ...</span>
<span class="co"># $ start_date                             : Date, format: NA NA ...</span>
<span class="co"># $ primary_completion_date                : Date, format: NA NA ...</span></code></pre></div>
<p>This facilitates using the respective type of data for analysis, for example of dates with base R graphics:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Open file for saving</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="st">"vignettes/nb1.png"</span><span class="op">)</span>
<span class="co"># Visualise trial start date</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span>
  <span class="va">result</span><span class="op">[[</span><span class="st">"n_date_of_competent_authority_decision"</span><span class="op">]</span><span class="op">]</span>, 
  breaks <span class="op">=</span> <span class="st">"years"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="nb1.png" alt=""><p class="caption">Histogram1</p>
</div>
</div>
<div id="merge-corresponding-fields-from-registers" class="section level1">
<h1 class="hasAnchor">
<a href="#merge-corresponding-fields-from-registers" class="anchor"></a>Merge corresponding fields from registers</h1>
<p>However, the field “n_date_of_competent_authority_decision” used above exists only in EUCTR, and it corresponds to the field “start_date” in CTGOV. Thus, to provide a wider picture, the two fields can be merged for analysis, using the convenience function <code><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel()</a></code> in <code>ctrdata</code> package:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Merge two variables into a new variable:</span>
<span class="va">result</span><span class="op">$</span><span class="va">trialstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span><span class="op">(</span>
  <span class="va">result</span>, 
  colnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"n_date_of_competent_authority_decision"</span>, 
    <span class="st">"start_date"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Plot from both registers</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="st">"vignettes/nb2.png"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span>
  <span class="va">result</span><span class="op">[[</span><span class="st">"trialstart"</span><span class="op">]</span><span class="op">]</span>, 
  breaks <span class="op">=</span> <span class="st">"years"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="nb2.png" alt=""><p class="caption">Histogram2</p>
</div>
<p>In a more sophisticated use of <code><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel()</a></code>, values of the original variables can be mapped into new values of the merged variable, as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># First, define how values of the new, merged variable </span>
<span class="co"># (e.g., "ongoing") will result from values of the </span>
<span class="co"># original variable (e.g, "Recruiting):</span>
<span class="va">mapped_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="st">"ongoing"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Recruiting"</span>, <span class="st">"Active"</span>, <span class="st">"Ongoing"</span>, 
                <span class="st">"Active, not recruiting"</span>, 
                <span class="st">"Enrolling by invitation"</span>, <span class="st">"Restarted"</span><span class="op">)</span>,
  <span class="st">"completed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Completed"</span>, <span class="st">"Prematurely Ended"</span>, <span class="st">"Terminated"</span><span class="op">)</span>,
  <span class="st">"other"</span>     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Withdrawn"</span>, <span class="st">"Suspended"</span>, <span class="st">"No longer available"</span>, 
                  <span class="st">"Not yet recruiting"</span>, <span class="st">"Temporarily Halted"</span>, 
                  <span class="st">"Unknown status"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Secondly, use the list of mapped</span>
<span class="co"># values when merging two variable: </span>
<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span><span class="op">(</span>
  <span class="va">result</span>, 
  colnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"overall_status"</span>, 
               <span class="st">"p_end_of_trial_status"</span><span class="op">)</span>, 
  levelslist <span class="op">=</span> <span class="va">mapped_values</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>
<span class="co"># completed   ongoing </span>
<span class="co">#       209         5 </span></code></pre></div>
</div>
<div id="annotations-made-by-user" class="section level1">
<h1 class="hasAnchor">
<a href="#annotations-made-by-user" class="anchor"></a>Annotations made by user</h1>
<p>The fields that <code>ctrdata</code> adds to each record are <code>annotation</code> and <code>record_last_import</code>. The annotation field is a single string that is only added if a user specifies an annotations when retrieving trials (<a href="ctrdata_retrieve.Rmd">Retrieve clinical trial information</a>). The last date and time when the trial record was imported is updated automatically. Also these fields can be used for analysis. For example, string functions can be used for annotations e.g. to split it into components. Since no annotations were specified when retrieving the trials in the steps above, there are so far no annotation fields and <code>stopifnodata</code> is set to <code>FALSE</code> to avoid the function raises an error to alert users:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span><span class="op">(</span>
  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"annotation"</span>, <span class="st">"record_last_import"</span><span class="op">)</span>, 
  stopifnodata <span class="op">=</span> <span class="cn">FALSE</span>,
  con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
 <span class="co"># $ _id               : chr  "2004-004386-15-DE" "2004-004386-15-ES"  ...</span>
 <span class="co"># $ annotation        : chr  "site_de" NA ...</span>
 <span class="co"># $ record_last_import: POSIXct, format: "2020-10-12 20:11:45" ...</span></code></pre></div>
</div>
<div id="analysing-nested-fields-such-as-trial-results" class="section level1">
<h1 class="hasAnchor">
<a href="#analysing-nested-fields-such-as-trial-results" class="anchor"></a>Analysing nested fields such as trial results</h1>
<p>The registers represent clinical trial information by nesting fields (e.g., several reporting groups within several measures within one of several endpoints). A visualisation of this hierarchical representation for CTGOV is this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># remotes::install_github("https://github.com/hrbrmstr/jsonview")</span>
<span class="fu">jsonview</span><span class="fu">::</span><span class="fu">json_tree_view</span><span class="op">(</span><span class="va">result</span><span class="op">[[</span><span class="st">"clinical_results.outcome_list.outcome"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>
 <span class="va">result</span><span class="op">[[</span><span class="st">"_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">"NCT00520936"</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="ctgovnested.png" alt=""><p class="caption">CtgovNested</p>
</div>
<p>The analysis of nested information such as the highlighted duration of response can be done with <code>ctrdata</code> as follows. The main steps are:</p>
<ul>
<li><p>to transform nested information to a long, name-value data.frame and then</p></li>
<li><p>to identify where the measures of interest (e.g. duration of response, blue circles above) are located in the information hierarchy by specifying the name and value of fields (<code>wherename</code>, <code>wherevalue</code>) and finally</p></li>
<li><p>to obtain the value of the item by specifying the name(s) of its value field(s) (<code>valuename</code>, red circles above).</p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 1. Create data frame from results fields. </span>
<span class="co"># These are the key results fields from </span>
<span class="co"># CTGOV and from EUCTR: </span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">ctrdata</span><span class="fu">::</span><span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span><span class="op">(</span>
  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="co"># CTGOV</span>
    <span class="st">"clinical_results.baseline.analyzed_list.analyzed.count_list.count"</span>,
    <span class="st">"clinical_results.baseline.group_list.group"</span>,
    <span class="st">"clinical_results.baseline.analyzed_list.analyzed.units"</span>,
    <span class="st">"clinical_results.outcome_list.outcome"</span>,
    <span class="st">"study_design_info.allocation"</span>,
    <span class="co"># EUCTR</span>
    <span class="st">"@attributes.eudractNumber"</span>,
    <span class="st">"trialInformation"</span>, 
    <span class="st">"subjectDisposition.recruitmentDetails"</span>, 
    <span class="st">"baselineCharacteristics.baselineReportingGroups.baselineReportingGroup"</span>,
    <span class="st">"endPoints.endPoint"</span>,
    <span class="st">"trialChanges.hasGlobalInterruptions"</span>,
    <span class="st">"subjectAnalysisSets"</span>,
    <span class="st">"adverseEvents.seriousAdverseEvents.seriousAdverseEvent"</span>
  <span class="op">)</span>,
  con <span class="op">=</span> <span class="va">db</span>
<span class="op">)</span>
<span class="co"># Keep only unique trial records</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span>
  <span class="va">result</span><span class="op">[[</span><span class="st">"_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">%in%</span> <span class="fu">ctrdata</span><span class="fu">::</span><span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span><span class="op">(</span>
    con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>,
<span class="op">]</span>

<span class="co"># 2. The columns of the results data.frame </span>
<span class="co"># contain nested lists of fields, see</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">[[</span><span class="st">"endPoints.endPoint"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="co"># All nested data are transformed to a long,</span>
<span class="co"># name-value data.frame (resulting in several</span>
<span class="co"># hundred rows per trial record): </span>
<span class="va">long_result</span> <span class="op">&lt;-</span> <span class="fu">ctrdata</span><span class="fu">::</span><span class="fu"><a href="../reference/dfTrials2Long.html">dfTrials2Long</a></span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">result</span>
<span class="op">)</span>

<span class="co"># 3. Obtain values for fields of interest where</span>
<span class="co"># they related to measures of interest. The</span>
<span class="co"># parameters can be regular expressions. </span>
<span class="va">dor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dfName2Value.html">dfName2Value</a></span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">long_result</span>,
  wherename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"clinical_results.*outcome.measure.title|"</span>, 
    <span class="st">"endPoints.endPoint.title"</span><span class="op">)</span>,
  wherevalue <span class="op">=</span> <span class="st">"duration of response"</span>,
  valuename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"endPoints.*armReportingGroup.tendencyValues.tendencyValue.value|"</span>,
    <span class="st">"clinical_results.*category_list.category.measurement_list.measurement.value"</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="co"># </span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">dor</span><span class="op">)</span>
<span class="co"># 'data.frame': 31 obs. of  5 variables:</span>
<span class="co">#  $ trial_id: chr  "2013-001142-34-GB" "2013-001142-34-GB" ...</span>
<span class="co">#  $ main_id : int  4 4 7 7 7 7 7 1 1 10 ...</span>
<span class="co">#  $ sub_id  : int  1 2 1 2 3 4 5 1 2 NA ...</span>
<span class="co">#  $ name    : chr  "endPoints.endPoint.armReportingGroups ...</span>
<span class="co">#  $ value   : num  7.2 18.6 706 84.5 413.5 ...</span>

<span class="co"># Just in this case and to make the example meaningful:</span>
<span class="co"># Duration of response has been reported variably in</span>
<span class="co"># months and days. Here, just select trials reporting </span>
<span class="co"># duration of response in months: </span>
<span class="va">dor</span> <span class="op">&lt;-</span> <span class="va">dor</span><span class="op">[</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"months"</span>, 
        <span class="fu"><a href="../reference/dfName2Value.html">dfName2Value</a></span><span class="op">(</span>
          df <span class="op">=</span> <span class="va">long_result</span>,
          wherename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
            <span class="st">"clinical_results.*outcome.measure.title|"</span>, 
            <span class="st">"endPoints.endPoint.title"</span><span class="op">)</span>,
          wherevalue <span class="op">=</span> <span class="st">"duration of response"</span>,
          valuename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
            <span class="st">"clinical_results.*measure.units|"</span>, 
            <span class="st">"endPoints.endPoint.unit"</span><span class="op">)</span>
        <span class="op">)</span><span class="op">[[</span><span class="st">"value"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># Finally plot</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="st">"vignettes/dorplot.png"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
  <span class="va">dor</span><span class="op">[[</span><span class="st">"value"</span><span class="op">]</span><span class="op">]</span>, 
  las <span class="op">=</span> <span class="fl">1</span>,
  xlab <span class="op">=</span> <span class="st">"Trial #"</span>,
  ylab <span class="op">=</span> <span class="st">"Duration of response [months]"</span>,
  main <span class="op">=</span> <span class="st">"Neuroblastoma trials"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="dorplot.png" alt=""><p class="caption">DoRplot</p>
</div>
</div>
<div id="analysing-primary-endpoints" class="section level1">
<h1 class="hasAnchor">
<a href="#analysing-primary-endpoints" class="anchor"></a>Analysing primary endpoints</h1>
<p>Text analysis has to be used for many fields of trial information from the registers. Here is an example to simply categorise the type of primary endpoint. In addition, the number of subjects are extracted and compared by type of primary endpoint.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Several "measure" entries are in "primary_outcome". </span>
<span class="co"># They are concatenated into a list when specifying</span>
<span class="co"># the JSON path "primary_outcome.measure"</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="co"># CTGOV</span>
  <span class="st">"primary_outcome.measure"</span>,
  <span class="st">"enrollment"</span>,
  <span class="co"># EUCTR</span>
  <span class="st">"e51_primary_end_points"</span>,
  <span class="co"># "f11_trial_has_subjects_under_18"</span>
  <span class="st">"f11_number_of_subjects_for_this_age_range"</span><span class="op">)</span>, 
  con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>

<span class="co"># De-duplicate </span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span> 
  <span class="va">result</span><span class="op">[[</span><span class="st">"_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">%in%</span> 
    <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span><span class="op">(</span>con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># Merge primary endpoint (pep)</span>
<span class="va">result</span><span class="op">$</span><span class="va">pep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">result</span>,
  colnames <span class="op">=</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"primary_outcome.measure"</span>,
      <span class="st">"e51_primary_end_points"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Merge number of subjects</span>
<span class="va">result</span><span class="op">$</span><span class="va">nsubj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">result</span>,
  colnames <span class="op">=</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"enrollment"</span>,
      <span class="st">"f11_number_of_subjects_for_this_age_range"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># For primary endpoint of interest, </span>
<span class="co"># use regular expression on text:</span>
<span class="va">result</span><span class="op">$</span><span class="va">pep_is_efs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span>
  pattern <span class="op">=</span> <span class="st">"((progression|event|relapse|recurrence|disease)[- ]free)|pfs|dfs|efs)"</span>, 
  x <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">pep</span>, 
  ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># Tabulate</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">pep_is_efs</span><span class="op">)</span>

<span class="co"># Plot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">result</span>, 
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">nsubj</span>,
           y <span class="op">=</span> <span class="va">pep_is_response</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_boxplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_x_log10</span><span class="op">(</span><span class="op">)</span>
<span class="co"># ggsave("vignettes/boxpep.png", width = 6, height = 4)</span></code></pre></div>
<div class="figure">
<img src="boxpep.png" alt=""><p class="caption">BoxPEP</p>
</div>
</div>
<div id="investigational-or-authorised-medicinal-product" class="section level1">
<h1 class="hasAnchor">
<a href="#investigational-or-authorised-medicinal-product" class="anchor"></a>Investigational or authorised medicinal product?</h1>
<p>The information about the status of authorisation (licensing) of a medicine used in a trial is record in EUCTR; a corresponding field in CTGOV is not known. The status is in the tree starting from the <code>dimp</code> element.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get results</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbGetFieldsIntoDf.html">dbGetFieldsIntoDf</a></span><span class="op">(</span>
  fields <span class="op">=</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a1_member_state_concerned"</span>, 
      <span class="st">"n_date_of_competent_authority_decision"</span>,
      <span class="st">"dimp.d21_imp_to_be_used_in_the_trial_has_a_marketing_authorisation"</span>, 
      <span class="st">"x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"</span>,
      <span class="st">"f422_in_the_whole_clinical_trial"</span>, 
      <span class="st">"a2_eudract_number"</span><span class="op">)</span>, 
  con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>
<span class="co"># Note: requested field dimp.d21_imp_to_be_used_in_the_trial_has_a_marketing_authorisation</span>
<span class="co"># has subitems dimp, collapsed using ' / '</span>

<span class="co"># Find first date of authorisation in EU member state</span>
<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>
  <span class="va">result</span><span class="op">[[</span><span class="st">"n_date_of_competent_authority_decision"</span><span class="op">]</span><span class="op">]</span>, 
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">result</span><span class="op">[[</span><span class="st">"a2_eudract_number"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
  FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="va">result</span>, 
  y <span class="op">=</span> <span class="va">tmp</span>, 
  by.x <span class="op">=</span> <span class="st">"a2_eudract_number"</span>, 
  by.y <span class="op">=</span> <span class="st">"Group.1"</span>, 
  all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">result</span><span class="op">[[</span><span class="st">"startdatefirst"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dfMergeTwoVariablesRelevel.html">dfMergeTwoVariablesRelevel</a></span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">result</span>,
  colnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"x"</span>, 
    <span class="st">"x6_date_on_which_this_record_was_first_entered_in_the_eudract_database"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Now de-duplicate</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span> 
  <span class="va">result</span><span class="op">[[</span><span class="st">"_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">%in%</span> 
    <span class="fu"><a href="../reference/dbFindIdsUniqueTrials.html">dbFindIdsUniqueTrials</a></span><span class="op">(</span>
      include3rdcountrytrials <span class="op">=</span> <span class="cn">FALSE</span>, 
      con <span class="op">=</span> <span class="va">db</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># How many of the investigational medicinal product(s) </span>
<span class="co"># used in the trial are authorised?</span>
<span class="va">number_authorised</span> <span class="op">&lt;-</span> <span class="fu">stringi</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_count.html">stri_count</a></span><span class="op">(</span>
  <span class="va">result</span><span class="op">[[</span><span class="st">"dimp.d21_imp_to_be_used_in_the_trial_has_a_marketing_authorisation"</span><span class="op">]</span><span class="op">]</span>, 
  fixed <span class="op">=</span> <span class="st">"Yes"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">number_authorised</span>, exclude <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="va">result</span><span class="op">[[</span><span class="st">"any_authorised"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">number_authorised</span> <span class="op">&gt;</span> <span class="fl">0</span>

<span class="co"># Plot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">scales</span><span class="op">)</span>
<span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">result</span>, 
  <span class="fu">aes</span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">startdatefirst</span>, 
    fill <span class="op">=</span> <span class="va">any_authorised</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    breaks <span class="op">=</span> <span class="fu">breaks_width</span><span class="op">(</span>width <span class="op">=</span> <span class="st">"2 years"</span><span class="op">)</span>, 
    labels <span class="op">=</span> <span class="fu">date_format</span><span class="op">(</span><span class="st">"%Y"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Neuroblastoma trials in EU"</span>, 
    x <span class="op">=</span> <span class="st">"Year of trial authorisation (or entered in EUCTR)"</span>, 
    y <span class="op">=</span> <span class="st">"Number of trials"</span>, 
    fill <span class="op">=</span> <span class="st">"Medicine\nauthorised?"</span><span class="op">)</span>
<span class="co"># ggsave("vignettes/nbtrials.png", width = 6, height = 4)</span></code></pre></div>
<div class="figure">
<img src="nbtrials.png" alt=""><p class="caption">HistogramNBtrials</p>
</div>
</div>
<div id="analyses-using-aggregation-pipeline-and-mapreduce" class="section level1">
<h1 class="hasAnchor">
<a href="#analyses-using-aggregation-pipeline-and-mapreduce" class="anchor"></a>Analyses using aggregation pipeline and mapreduce</h1>
<p>Here are example of analysis functions that can be run on the MongoDB server, which are fast and do not consume R resources.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load library for database access</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jeroen/mongolite/">mongolite</a></span><span class="op">)</span>

<span class="co"># Creat R object m to access the </span>
<span class="co"># collection created above:</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">db</span><span class="op">[[</span><span class="st">"url"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"/"</span>, <span class="va">db</span><span class="op">[[</span><span class="st">"db"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
           collection <span class="op">=</span> <span class="va">db</span><span class="op">[[</span><span class="st">"collection"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Number of records in  collection:</span>
<span class="va">m</span><span class="op">$</span><span class="fu">count</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Number of EUCTR records, using JSON for query:</span>
<span class="va">m</span><span class="op">$</span><span class="fu">count</span><span class="op">(</span>query <span class="op">=</span> <span class="st">'{"_id": {"$regex": "[0-9]{4}-[0-9]{6}-[0-9]{2}", 
                 "$options": "i"}}'</span><span class="op">)</span>
<span class="co"># Alternative: </span>
<span class="va">m</span><span class="op">$</span><span class="fu">count</span><span class="op">(</span>query <span class="op">=</span> <span class="st">'{"ctrname": "EUCTR"}'</span><span class="op">)</span>

<span class="co"># Number of CTGOV records:</span>
<span class="va">m</span><span class="op">$</span><span class="fu">count</span><span class="op">(</span>query <span class="op">=</span> <span class="st">'{"_id": {"$regex": "NCT[0-9]{8}", 
                 "$options": "i"}}'</span><span class="op">)</span>
<span class="co"># Alternative:</span>
<span class="va">m</span><span class="op">$</span><span class="fu">count</span><span class="op">(</span>query <span class="op">=</span> <span class="st">'{"ctrname": "CTGOV"}'</span><span class="op">)</span>


<span class="co"># The following examples use the aggregation pipeline in MongoDB:</span>

<span class="co"># See here for details on mongo's aggregation pipleline: </span>
<span class="co"># https://docs.mongodb.org/manual/core/aggregation-pipeline/</span>
 
<span class="co"># To best define regular expressions for analyses, </span>
<span class="co"># inspect the field (here, primary_outcome.measure):</span>
<span class="co"># Regular expressions ("$regex") are case insensitive ("i")</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>
  <span class="va">m</span><span class="op">$</span><span class="fu">distinct</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"primary_outcome.measure"</span>, 
             query <span class="op">=</span> <span class="st">'{"_id": {"$regex": "NCT[0-9]{8}", "$options": "i"}}'</span><span class="op">)</span><span class="op">)</span>


<span class="co"># [Example 1.] Total count of PFS, EFS, RFS or DFS</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span>
  <span class="co"># Count number of documents in collection that </span>
  <span class="co"># matches in primary_outcome.measure the </span>
  <span class="co"># regular expression, </span>
  pipeline <span class="op">=</span> 
    <span class="st">'[{"$match": {"primary_outcome.measure": 
      {"$regex": "(progression|event|relapse|recurrence|disease)[- ]free", 
                 "$options": "i"}}}, 
      {"$group": {"_id": "null", "count": {"$sum": 1}}}]'</span><span class="op">)</span>
<span class="va">out</span>


<span class="co"># [Example 2.] Lists records of OS trials with start date</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span>
  pipeline <span class="op">=</span> 
    <span class="st">'[{"$match": {"primary_outcome.measure": 
      {"$regex": "overall survival", "$options": "i"}}}, 
      {"$project": {"_id": 1, "start_date": 1}}]'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="co">#           _id   start_date</span>
<span class="co"># 1 NCT00793845  August 2008</span>
<span class="co"># 2 NCT00923351 June 2, 2007</span>


<span class="co"># [Example 3.] Count number of trials by number of</span>
<span class="co"># study participants in bins of hundreds of participants:</span>
<span class="va">hist</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="fu">mapreduce</span><span class="op">(</span>
  map <span class="op">=</span> <span class="st">"function(){emit(Math.floor(this.f422_in_the_whole_clinical_trial/100)*100, 1)}"</span>, 
  reduce <span class="op">=</span> <span class="st">"function(id, counts){return Array.sum(counts)}"</span>
<span class="op">)</span>

<span class="va">hist</span>
<span class="co">#    _id value</span>
<span class="co"># 1  NaN   195</span>
<span class="co"># 2    0    74</span>
<span class="co"># 3  100    35</span>
<span class="co"># 4  200     4</span>
<span class="co"># 5  600     1</span>
<span class="co"># 6 2200     4</span>
<span class="co"># 7 2700     2</span>
<span class="co"># 8 3300     4</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ralf Herold.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'c06ec790dbbaffba8e7b188f745a4353',
    indexName: 'ctrdata',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
